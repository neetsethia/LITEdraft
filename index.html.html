<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>LiteDraft Pro</title>
    <style>
        :root {
            --bg: #000; --panel: rgba(28, 28, 30, 0.9); --accent: #0a84ff;
            --text: #fff; --border: #38383a; --danger: #ff453a; --success: #32d74b;
        }
        body { 
            margin: 0; display: flex; height: 100vh; font-family: -apple-system, sans-serif; 
            background: var(--bg); color: var(--text); overflow: hidden; touch-action: none;
        }
        
        /* Layout UI */
        #sidebar { 
            position: absolute; left: 15px; top: 15px; bottom: 15px; width: 65px; 
            background: var(--panel); border: 1px solid var(--border); border-radius: 14px; 
            display: flex; flex-direction: column; gap: 10px; padding: 15px 5px; 
            align-items: center; box-shadow: 0 8px 32px rgba(0,0,0,0.5); backdrop-filter: blur(20px); z-index: 100; 
        }
        #topbar { 
            position: absolute; top: 15px; left: 95px; right: 15px; height: 55px; 
            background: var(--panel); border: 1px solid var(--border); border-radius: 14px; 
            display: flex; align-items: center; padding: 0 15px; gap: 12px; backdrop-filter: blur(20px); z-index: 99; 
        }
        #settings-panel {
            position: absolute; left: 95px; top: 80px; background: var(--panel);
            border: 1px solid var(--border); border-radius: 10px; padding: 10px;
            display: flex; gap: 15px; font-size: 11px; backdrop-filter: blur(10px); z-index: 98;
        }
        #legend-panel {
            position: absolute; right: 15px; bottom: 85px; width: 220px;
            background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
            padding: 15px; display: none; backdrop-filter: blur(20px); z-index: 97;
        }

        canvas { background: var(--bg); cursor: crosshair; flex-grow: 1; display: block; }
        
        .tool-btn { 
            width: 48px; height: 48px; border-radius: 10px; border: none; 
            background: transparent; color: var(--text); font-size: 20px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
        }
        .tool-btn.active { background: var(--accent); }
        .action-btn { 
            background: #3a3a3c; color: white; border: none; padding: 8px 14px; 
            border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; 
        }
        select { background: #3a3a3c; color: white; border: none; padding: 6px; border-radius: 6px; font-size: 11px; }
        .stats { margin-left: auto; font-family: monospace; color: var(--accent); font-weight: bold; }
        .legend-item { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }

        #exit-pres {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 30px; border: none; background: #000;
            color: #fff; font-weight: bold; cursor: pointer; z-index: 1001; display: none;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <button class="tool-btn active" onclick="setTool('line')" id="lineBtn">üìè</button>
    <button class="tool-btn" onclick="setTool('rect')" id="rectBtn">‚¨ú</button>
    <button class="tool-btn" onclick="setTool('symbol')" id="symbolBtn">üö™</button>
    <button class="tool-btn" onclick="setTool('text')" id="textBtn">A</button>
    <button class="tool-btn" onclick="setTool('tape')" id="tapeBtn">üìç</button>
    <hr style="width:50%; border:0.5px solid var(--border);">
    <button class="tool-btn" onclick="setTool('eraser')" id="eraserBtn">üßπ</button>
    <button class="tool-btn" onclick="undo()">‚ü≤</button>
</div>

<div id="topbar">
    <button class="action-btn" id="unitBtn" onclick="toggleUnits()">IMPERIAL</button>
    <select id="scaleSelect" onchange="changeScale(this.value)"></select>
    <select id="tradeSelect" onchange="switchTrade(this.value)"></select>
    <button class="action-btn" onclick="rotateTool()" id="rotateBtn">ROT: 0¬∞</button>
    <button class="action-btn" onclick="togglePresentation()" style="background:var(--success)">PRESENT</button>
    <button class="action-btn" onclick="generateShareLink()" style="background:var(--accent)">SYNC</button>
    <div class="stats" id="coords">0.0' , 0.0'</div>
</div>

<div id="settings-panel">
    <span>Wall Thk: <select id="wallThk" onchange="wallThickness=parseFloat(this.value)"><option value="0.5">6"</option><option value="0.33">4"</option></select></span>
    <span>Material: <select id="hatchType" onchange="activeHatch=this.value"><option value="solid">Solid</option><option value="brick">Brick</option></select></span>
    <button class="action-btn" onclick="toggleLegend()">SCHEDULE</button>
</div>

<div id="legend-panel">
    <h5 style="margin:0 0 10px 0; color:var(--accent)">COMPONENT SCHEDULE</h5>
    <div id="legend-content"></div>
</div>

<button id="exit-pres" onclick="togglePresentation()">EXIT PRESENTATION</button>

<canvas id="draftCanvas"></canvas>

<script>
    const canvas = document.getElementById('draftCanvas'), ctx = canvas.getContext('2d');
    let shapes = [], drawing = false, tool = 'line', tempTape = null, isPres = false;
    let unitSystem = 'imperial', activeScale = '1/4"', currentScaleVal = 24;
    let activeTrade = 'Architectural', wallThickness = 0.5, activeHatch = 'solid', currentRotation = 0;

    const SCALES = {
        imperial: { '1/8"': 12, '1/4"': 24, '1/2"': 48 },
        metric: { '1:100': 20, '1:50': 40, '1:20': 100 }
    };

    const TRADES = {
        'Architectural': { layer: 'Walls', color: '#FFFFFF', symbol: 'door' },
        'Electrical': { layer: 'Electrical', color: '#FFD60A', symbol: 'outlet' },
        'Plumbing': { layer: 'Plumbing', color: '#32ADE6', symbol: 'drain' }
    };

    const SYMBOLS = {
        door: (ctx, x, y, rot) => {
            const s = 3 * currentScaleVal;
            ctx.save(); ctx.translate(x, y); ctx.rotate(rot * Math.PI/180);
            ctx.beginPath(); ctx.arc(0, 0, s, 1.5 * Math.PI, 2 * Math.PI); ctx.lineTo(0,0); ctx.lineTo(0,-s); ctx.stroke(); ctx.restore();
        },
        outlet: (ctx, x, y, rot) => {
            ctx.save(); ctx.translate(x, y); ctx.rotate(rot * Math.PI/180);
            ctx.beginPath(); ctx.arc(0, 0, 6, 0, Math.PI*2); ctx.moveTo(-8,0); ctx.lineTo(8,0); ctx.stroke(); ctx.restore();
        },
        drain: (ctx, x, y) => {
            ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.moveTo(x-6,y-6); ctx.lineTo(x+6,y+6); ctx.moveTo(x+6,y-6); ctx.lineTo(x-6,y+6); ctx.stroke();
        }
    };

    const dpr = window.devicePixelRatio || 1;
    function resize() {
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr); render();
    }

    function switchTrade(t) {
        activeTrade = t; 
        document.getElementById('symbolBtn').innerText = (t === 'Architectural' ? 'üö™' : (t === 'Electrical' ? 'üîå' : 'üíß'));
        render();
    }

    function toggleUnits() {
        unitSystem = unitSystem === 'imperial' ? 'metric' : 'imperial';
        const sel = document.getElementById('scaleSelect'); sel.innerHTML = '';
        Object.keys(SCALES[unitSystem]).forEach(k => sel.add(new Option(k, k)));
        activeScale = Object.keys(SCALES[unitSystem])[0];
        currentScaleVal = SCALES[unitSystem][activeScale];
        document.getElementById('unitBtn').innerText = unitSystem.toUpperCase();
        render();
    }

    function changeScale(v) { activeScale = v; currentScaleVal = SCALES[unitSystem][v]; render(); }
    function rotateTool() { currentRotation = (currentRotation + 90) % 360; document.getElementById('rotateBtn').innerText = `ROT: ¬∞`; }

    function togglePresentation() {
        isPres = !isPres;
        const ui = ['sidebar', 'topbar', 'settings-panel', 'legend-panel'];
        ui.forEach(id => document.getElementById(id).style.display = isPres ? 'none' : (id === 'legend-panel' ? 'none' : ''));
        document.getElementById('exit-pres').style.display = isPres ? 'block' : 'none';
        render();
    }

    function getSnap(mx, my) {
        let best = { x: Math.round(mx/currentScaleVal)*currentScaleVal, y: Math.round(my/currentScaleVal)*currentScaleVal };
        shapes.forEach(s => {
            const pts = s.type === 'line' ? [{x:s.x1, y:s.y1}, {x:s.x2, y:s.y2}] : [];
            pts.forEach(p => { if(Math.hypot(mx-p.x, my-p.y) < 15) best = {x:p.x, y:p.y}; });
        });
        return best;
    }

    canvas.addEventListener('pointerdown', e => {
        const snap = getSnap(e.offsetX, e.offsetY);
        if (tool === 'eraser') { eraseAt(e.offsetX, e.offsetY); return; }
        if (tool === 'tape') { tempTape = {x1:e.offsetX, y1:e.offsetY, x2:e.offsetX, y2:e.offsetY}; return; }
        if (tool === 'text') {
            const txt = prompt("Room Label:");
            if(txt) { shapes.push({type:'text', label:txt, x:e.offsetX, y:e.offsetY, layer:TRADES[activeTrade].layer}); save(); render(); }
            return;
        }
        if (tool === 'symbol') {
            shapes.push({type:'symbol', symbolType:TRADES[activeTrade].symbol, x:snap.x, y:snap.y, rotation:currentRotation, layer:TRADES[activeTrade].layer});
            save(); render(); return;
        }
        drawing = true; startX = snap.x; startY = snap.y;
    });

    canvas.addEventListener('pointermove', e => {
        const snap = getSnap(e.offsetX, e.offsetY);
        const unitLabel = unitSystem === 'imperial' ? "'" : "m";
        document.getElementById('coords').innerText = `${(snap.x/currentScaleVal).toFixed(1)} , ${(snap.y/currentScaleVal).toFixed(1)}`;
        
        if (tempTape) { tempTape.x2 = e.offsetX; tempTape.y2 = e.offsetY; render(); return; }
        if (!drawing) return;
        render();
        ctx.setLineDash([5,5]); ctx.strokeStyle = "#888";
        if(tool==='line') { ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(snap.x, snap.y); ctx.stroke(); }
        else if(tool==='rect') ctx.strokeRect(startX, startY, snap.x-startX, snap.y-startY);
    });

    canvas.addEventListener('pointerup', e => {
        if (tempTape) { tempTape = null; render(); return; }
        if (!drawing) return;
        const snap = getSnap(e.offsetX, e.offsetY);
        const weight = (e.pressure || 0.5) * 4 + 1;
        if(tool==='line') shapes.push({type:'line', x1:startX, y1:startY, x2:snap.x, y2:snap.y, weight, layer:TRADES[activeTrade].layer});
        else if(tool==='rect') shapes.push({type:'rect', x:startX, y:startY, w:snap.x-startX, h:snap.y-startY, weight, layer:TRADES[activeTrade].layer});
        drawing = false; save(); render();
    });

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.style.background = isPres ? "#fdfdfd" : "#000";
        if (!isPres) drawGrid();

        shapes.forEach(s => {
            const isFocus = s.layer === TRADES[activeTrade].layer;
            ctx.strokeStyle = isPres ? "#000" : (isFocus ? TRADES[activeTrade].color : "#444");
            ctx.lineWidth = s.weight || 2; ctx.setLineDash([]);
            ctx.shadowBlur = (!isPres && isFocus && s.layer !== 'Walls') ? 8 : 0;
            ctx.shadowColor = ctx.strokeStyle;
            
            if (s.type === 'line') {
                ctx.beginPath(); ctx.moveTo(s.x1, s.y1); ctx.lineTo(s.x2, s.y2); ctx.stroke();
                if(!isPres) drawDim(s.x1, s.y1, s.x2, s.y2);
            } else if (s.type === 'rect') {
                if(isPres && s.layer === 'Walls') { ctx.fillStyle="#000"; ctx.fillRect(s.x, s.y, s.w, s.h); }
                ctx.strokeRect(s.x, s.y, s.w, s.h);
                if(!isPres) {
                    const area = (Math.abs(s.w*s.h) / (currentScaleVal**2)).toFixed(1);
                    ctx.fillStyle = "#888"; ctx.font = "10px sans-serif";
                    ctx.fillText(area + (unitSystem==='imperial'?" sq ft":" m¬≤"), s.x + s.w/2 - 15, s.y + s.h/2);
                }
            } else if (s.type === 'symbol') SYMBOLS[s.symbolType](ctx, s.x, s.y, s.rotation);
            else if (s.type === 'text') {
                ctx.fillStyle = isPres ? "#000" : "#fff"; ctx.font = "bold 13px sans-serif";
                ctx.fillText(s.label.toUpperCase(), s.x, s.y);
            }
        });
        if(tempTape) drawTape();
    }

    function drawGrid() {
        ctx.strokeStyle = "#111"; ctx.lineWidth = 1;
        for (let i = 0; i < canvas.width; i += currentScaleVal) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke(); }
        for (let i = 0; i < canvas.height; i += currentScaleVal) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke(); }
    }

    function drawDim(x1, y1, x2, y2) {
        const d = (Math.hypot(x2-x1, y2-y1) / currentScaleVal).toFixed(1);
        ctx.fillStyle = "#0a84ff"; ctx.font = "10px monospace";
        ctx.fillText(d + (unitSystem==='imperial'?"'":"m"), (x1+x2)/2, (y1+y2)/2 - 5);
    }

    function drawTape() {
        ctx.setLineDash([2,2]); ctx.strokeStyle = "#ff9800"; ctx.beginPath();
        ctx.moveTo(tempTape.x1, tempTape.y1); ctx.lineTo(tempTape.x2, tempTape.y2); ctx.stroke();
        const d = (Math.hypot(tempTape.x2-tempTape.x1, tempTape.y2-tempTape.y1) / currentScaleVal).toFixed(2);
        ctx.fillStyle = "#ff9800"; ctx.fillRect(tempTape.x2+5, tempTape.y2-20, 50, 18);
        ctx.fillStyle = "#000"; ctx.fillText(d + (unitSystem==='imperial'?"'":"m"), tempTape.x2+8, tempTape.y2-7);
    }

    function setTool(t) { tool = t; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById(t+'Btn').classList.add('active'); }
    function save() { localStorage.setItem('ld_final_pro', JSON.stringify(shapes)); }
    function undo() { shapes.pop(); save(); render(); }
    function eraseAt(x, y) { shapes = shapes.filter(s => Math.hypot((s.x || s.x1) - x, (s.y || s.y1) - y) > 25); save(); render(); }
    
    function toggleLegend() { 
        const p = document.getElementById('legend-panel'); 
        p.style.display = p.style.display === 'block' ? 'none' : 'block'; 
        if(p.style.display === 'block') updateLegend(); 
    }

    function updateLegend() {
        const cont = document.getElementById('legend-content'); cont.innerHTML = '';
        const counts = {};
        shapes.forEach(s => { const k = s.symbolType || s.type; counts[k] = (counts[k] || 0) + 1; });
        for(let k in counts) cont.innerHTML += `<div class="legend-item"><span></span><span>x</span></div>`;
    }

    function generateShareLink() {
        const data = btoa(encodeURIComponent(JSON.stringify(shapes)));
        const url = window.location.origin + window.location.pathname + '?data=' + data;
        navigator.clipboard.writeText(url).then(() => alert("Cloud Sync Link Copied to Clipboard!"));
    }

    window.onload = () => {
        const tSel = document.getElementById('tradeSelect'); Object.keys(TRADES).forEach(t => tSel.add(new Option(t, t)));
        toggleUnits(); resize();
        const params = new URLSearchParams(window.location.search);
        if(params.get('data')) shapes = JSON.parse(decodeURIComponent(atob(params.get('data'))));
        else shapes = JSON.parse(localStorage.getItem('ld_final_pro') || '[]');
        render();
    };
    window.addEventListener('resize', resize);
    window.addEventListener('keydown', e => { 
        if(e.code==='Space') { e.preventDefault(); rotateTool(); } 
        if(e.ctrlKey && e.key==='z') undo();
        if(e.key==='Escape' && isPres) togglePresentation();
    });
</script>
</body>
</html>
